<template>
  <div class="outbound-management">
    <!-- È°µÈù¢Ê†áÈ¢òÊ†è -->
    <div class="page-header">
      <h1>ÂèëË¥ßÁÆ°ÁêÜ</h1>
      <div class="header-actions">
        <el-button type="success" @click="exportData">
          <el-icon><Download /></el-icon>
          ÂØºÂá∫ËÆ∞ÂΩï
        </el-button>
        <el-button type="primary" @click="refreshData">
          <el-icon><Refresh /></el-icon>
          Âà∑Êñ∞Êï∞ÊçÆ
      </el-button>
      </div>
    </div>

    <!-- ÂäüËÉΩÊ†áÁ≠æÈ°µ -->
    <div class="tabs-container">
      <el-tabs v-model="activeTab" type="card" class="outbound-tabs" @tab-change="handleTabChange">
        <el-tab-pane label="ÂèëË¥ßÂçï" name="orders">
          <template #label>
            <div class="tab-icon">
              <el-icon><Document /></el-icon>
              <span>ÂèëË¥ßÂçï</span>
              <el-badge v-if="orderStats.draft > 0" :value="orderStats.draft" class="tab-badge" />
            </div>
          </template>
        </el-tab-pane>
        <el-tab-pane label="È¢ÑÂèëË¥ß" name="pre_delivery">
          <template #label>
            <div class="tab-icon">
              <el-icon><Clock /></el-icon>
              <span>È¢ÑÂèëË¥ß</span>
              <el-badge v-if="orderStats.pre_delivery > 0" :value="orderStats.pre_delivery" class="tab-badge" />
            </div>
          </template>
        </el-tab-pane>
        <el-tab-pane label="Êã£Ë¥ß" name="picking">
          <template #label>
            <div class="tab-icon">
              <el-icon><Box /></el-icon>
              <span>Êã£Ë¥ß</span>
              <el-badge v-if="orderStats.picking > 0" :value="orderStats.picking" class="tab-badge" />
            </div>
          </template>
        </el-tab-pane>
        <el-tab-pane label="ÊâìÂåÖ" name="packing">
          <template #label>
            <div class="tab-icon">
              <el-icon><Present /></el-icon>
              <span>ÊâìÂåÖ</span>
              <el-badge v-if="orderStats.packing > 0" :value="orderStats.packing" class="tab-badge" />
            </div>
          </template>
        </el-tab-pane>
        <el-tab-pane label="ÂèëË¥ß" name="shipping">
          <template #label>
            <div class="tab-icon">
              <el-icon><Truck /></el-icon>
              <span>ÂèëË¥ß</span>
              <el-badge v-if="orderStats.shipping > 0" :value="orderStats.shipping" class="tab-badge" />
            </div>
          </template>
        </el-tab-pane>
      </el-tabs>
    </div>

    <!-- ÁªüËÆ°Âç°Áâá -->
    <div class="stats-cards">
      <el-row :gutter="20">
        <el-col :span="4">
      <el-card class="stat-card">
        <div class="stat-content">
              <div class="stat-icon draft">
            <el-icon><Document /></el-icon>
          </div>
          <div class="stat-info">
                <div class="stat-value">{{ orderStats.draft }}</div>
                <div class="stat-label">ËçâÁ®ø</div>
          </div>
        </div>
      </el-card>
        </el-col>
        <el-col :span="4">
      <el-card class="stat-card">
        <div class="stat-content">
              <div class="stat-icon pre-delivery">
            <el-icon><Clock /></el-icon>
          </div>
          <div class="stat-info">
                <div class="stat-value">{{ orderStats.pre_delivery }}</div>
                <div class="stat-label">È¢ÑÂèëË¥ß</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="4">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-icon picking">
                <el-icon><Box /></el-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ orderStats.picking }}</div>
                <div class="stat-label">Êã£Ë¥ß‰∏≠</div>
          </div>
        </div>
      </el-card>
        </el-col>
        <el-col :span="4">
      <el-card class="stat-card">
        <div class="stat-content">
              <div class="stat-icon packing">
                <el-icon><Present /></el-icon>
          </div>
          <div class="stat-info">
                <div class="stat-value">{{ orderStats.packing }}</div>
                <div class="stat-label">ÊâìÂåÖ‰∏≠</div>
          </div>
        </div>
      </el-card>
        </el-col>
        <el-col :span="4">
      <el-card class="stat-card">
        <div class="stat-content">
              <div class="stat-icon shipping">
            <el-icon><Truck /></el-icon>
          </div>
          <div class="stat-info">
                <div class="stat-value">{{ orderStats.shipping }}</div>
                <div class="stat-label">ÂæÖÂèëË¥ß</div>
              </div>
            </div>
          </el-card>
        </el-col>
        <el-col :span="4">
          <el-card class="stat-card">
            <div class="stat-content">
              <div class="stat-icon completed">
                <el-icon><Check /></el-icon>
              </div>
              <div class="stat-info">
                <div class="stat-value">{{ orderStats.completed }}</div>
                <div class="stat-label">Â∑≤ÂÆåÊàê</div>
          </div>
        </div>
      </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- Ê†áÁ≠æÈ°µÂÜÖÂÆπ -->
    <div class="tab-content">
      <!-- ÂèëË¥ßÂçïÁÆ°ÁêÜ -->
      <div v-show="activeTab === 'orders'">
        <OutboundOrders ref="outboundOrdersRef" @refresh="handleRefresh" />
      </div>
      
      <!-- È¢ÑÂèëË¥ßÁÆ°ÁêÜ -->
      <div v-show="activeTab === 'pre_delivery'">
        <PreDelivery ref="preDeliveryRef" @refresh="handleRefresh" />
            </div>
            
      <!-- Êã£Ë¥ßÁÆ°ÁêÜ -->
      <div v-show="activeTab === 'picking'">
        <PickingGoods ref="pickingGoodsRef" @refresh="handleRefresh" />
          </div>
      
      <!-- ÊâìÂåÖÁÆ°ÁêÜ -->
      <div v-show="activeTab === 'packing'">
        <PackingGoods ref="packingGoodsRef" @refresh="handleRefresh" />
      </div>
      
      <!-- ÂèëË¥ßÁÆ°ÁêÜ -->
      <div v-show="activeTab === 'shipping'">
        <ShippingGoods ref="shippingGoodsRef" @refresh="handleRefresh" />
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, nextTick } from 'vue'
import { ElMessage } from 'element-plus'
import OutboundOrders from './components/OutboundOrders.vue'
import PreDelivery from './components/PreDelivery.vue'
import PickingGoods from './components/PickingGoods.vue'
import PackingGoods from './components/PackingGoods.vue'
import ShippingGoods from './components/ShippingGoods.vue'

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const activeTab = ref('orders')

// ÁªÑ‰ª∂ÂºïÁî®
const outboundOrdersRef = ref()
const preDeliveryRef = ref()
const pickingGoodsRef = ref()
const packingGoodsRef = ref()
const shippingGoodsRef = ref()

// ËÆ¢ÂçïÁªüËÆ°Êï∞ÊçÆ
const orderStats = reactive({
  draft: 0,
  pre_delivery: 0,
  picking: 0,
  packing: 0,
  shipping: 0,
  completed: 0,
  cancelled: 0,
  total: 0
})

// Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
const loadStats = async () => {
  try {
    // ‰ªélocalStorageËé∑ÂèñÂá∫Â∫ìÂçïÊï∞ÊçÆ
    const orders = JSON.parse(localStorage.getItem('outbound_orders') || '[]')
    console.log('Orders - ÊâÄÊúâÂá∫Â∫ìÂçïÊï∞ÊçÆ:', orders)
    
    // ÁªüËÆ°ÂêÑÁä∂ÊÄÅÁöÑËÆ¢ÂçïÊï∞Èáè
    const stats = {
      draft: 0,
      pre_delivery: 0,
      picking: 0,
      packing: 0,
      shipping: 0,
      completed: 0,
      cancelled: 0,
      total: orders.length
    }
    
    orders.forEach(order => {
      if (stats.hasOwnProperty(order.status)) {
        stats[order.status]++
      }
    })
    
    // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
    Object.assign(orderStats, stats)
    
    console.log('Âá∫Â∫ìËÆ¢ÂçïÁªüËÆ°:', stats)
    console.log('Êõ¥Êñ∞ÂêéÁöÑorderStats:', orderStats)
  } catch (error) {
    console.error('Âä†ËΩΩÂá∫Â∫ìÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error)
  }
}

// Â§ÑÁêÜÂ≠êÁªÑ‰ª∂ÂèëÂá∫ÁöÑÂà∑Êñ∞‰∫ã‰ª∂
const handleRefresh = async () => {
  console.log('üîÑ Êé•Êî∂Âà∞Âà∑Êñ∞‰∫ã‰ª∂ÔºåÂºÄÂßãÂà∑Êñ∞ÊâÄÊúâÁªÑ‰ª∂...')
  
  // Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
  await loadStats()
  
  // Âà∑Êñ∞ÊâÄÊúâÁªÑ‰ª∂ÁöÑÊï∞ÊçÆ
  await refreshAllComponents()
}

// Âà∑Êñ∞ÊâÄÊúâÁªÑ‰ª∂Êï∞ÊçÆ
const refreshAllComponents = async () => {
  try {
    // Âà∑Êñ∞ÂêÑ‰∏™ÁªÑ‰ª∂ÁöÑÊï∞ÊçÆ
    if (outboundOrdersRef.value && typeof outboundOrdersRef.value.loadOrderList === 'function') {
      await outboundOrdersRef.value.loadOrderList()
    }
    if (preDeliveryRef.value && typeof preDeliveryRef.value.loadTableData === 'function') {
      await preDeliveryRef.value.loadTableData()
    }
    if (pickingGoodsRef.value && typeof pickingGoodsRef.value.loadTableData === 'function') {
      await pickingGoodsRef.value.loadTableData()
    }
    if (packingGoodsRef.value && typeof packingGoodsRef.value.loadTableData === 'function') {
      await packingGoodsRef.value.loadTableData()
    }
    if (shippingGoodsRef.value && typeof shippingGoodsRef.value.loadTableData === 'function') {
      await shippingGoodsRef.value.loadTableData()
    }
    
    console.log('‚úÖ ÊâÄÊúâÁªÑ‰ª∂Êï∞ÊçÆÂ∑≤Âà∑Êñ∞')
  } catch (error) {
    console.error('Âà∑Êñ∞ÁªÑ‰ª∂Êï∞ÊçÆÂ§±Ë¥•:', error)
  }
}

// Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
const refreshStats = () => {
  loadStats()
}

// Âà∑Êñ∞Êï∞ÊçÆ
const refreshData = () => {
  loadStats()
  ElMessage.success('Êï∞ÊçÆÂ∑≤Âà∑Êñ∞')
}

// ÂØºÂá∫Êï∞ÊçÆ
const exportData = () => {
  try {
    const orders = JSON.parse(localStorage.getItem('outbound_orders') || '[]')
    
    if (orders.length === 0) {
      ElMessage.warning('ÊöÇÊó†Êï∞ÊçÆÂèØÂØºÂá∫')
      return
    }
    
    // ÁÆÄÂçïÁöÑCSVÂØºÂá∫
    const headers = ['Âá∫Â∫ìÂçïÂè∑', 'ÂÆ¢Êà∑ÂêçÁß∞', 'Âá∫Â∫ìÁ±ªÂûã', 'Áä∂ÊÄÅ', 'ÊÄªÊï∞Èáè', 'ÊÄªÈáëÈ¢ù', 'ÂàõÂª∫Êó∂Èó¥']
    const csvContent = [
      headers.join(','),
      ...orders.map(order => [
        order.order_no,
        order.customer_name,
        order.outbound_type,
        order.status,
        order.products ? order.products.reduce((sum, p) => sum + (p.quantity || 0), 0) : 0,
        order.products ? order.products.reduce((sum, p) => sum + (p.amount || 0), 0) : 0,
        order.created_at
      ].join(','))
    ].join('\n')
    
    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    const url = URL.createObjectURL(blob)
    link.setAttribute('href', url)
    link.setAttribute('download', `Âá∫Â∫ìÂçïËÆ∞ÂΩï_${new Date().toISOString().slice(0, 10)}.csv`)
    link.style.visibility = 'hidden'
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    
    ElMessage.success('Êï∞ÊçÆÂØºÂá∫ÊàêÂäü')
  } catch (error) {
    ElMessage.error('Êï∞ÊçÆÂØºÂá∫Â§±Ë¥•')
    console.error('ÂØºÂá∫Â§±Ë¥•:', error)
  }
}

// Ê†áÁ≠æÈ°µÂàáÊç¢
const handleTabChange = async (tabName) => {
  console.log('üîÑ ÂàáÊç¢Âà∞Ê†áÁ≠æÈ°µ:', tabName)
  
  // Á≠âÂæÖ‰∏Ä‰∏™ÂæÆ‰ªªÂä°Âë®ÊúüÔºåÁ°Æ‰øùÁªÑ‰ª∂Â∑≤Ê∏≤Êüì
  await nextTick()
  
  // Ê†πÊçÆÂΩìÂâçÊ†áÁ≠æÈ°µÂà∑Êñ∞ÂØπÂ∫îÁªÑ‰ª∂ÁöÑÊï∞ÊçÆ
  try {
    switch (tabName) {
      case 'orders':
        if (outboundOrdersRef.value && typeof outboundOrdersRef.value.loadOrderList === 'function') {
          console.log('üîÑ Âà∑Êñ∞ÂèëË¥ßÂçïÊï∞ÊçÆ')
          await outboundOrdersRef.value.loadOrderList()
        }
        break
      case 'pre_delivery':
        if (preDeliveryRef.value && typeof preDeliveryRef.value.loadTableData === 'function') {
          console.log('üîÑ Âà∑Êñ∞È¢ÑÂèëË¥ßÊï∞ÊçÆ')
          await preDeliveryRef.value.loadTableData()
        }
        break
      case 'picking':
        if (pickingGoodsRef.value && typeof pickingGoodsRef.value.loadTableData === 'function') {
          console.log('üîÑ Âà∑Êñ∞Êã£Ë¥ßÊï∞ÊçÆ')
          await pickingGoodsRef.value.loadTableData()
        }
        break
      case 'packing':
        if (packingGoodsRef.value && typeof packingGoodsRef.value.loadTableData === 'function') {
          console.log('üîÑ Âà∑Êñ∞ÊâìÂåÖÊï∞ÊçÆ')
          await packingGoodsRef.value.loadTableData()
        }
        break
      case 'shipping':
        if (shippingGoodsRef.value && typeof shippingGoodsRef.value.loadTableData === 'function') {
          console.log('üîÑ Âà∑Êñ∞ÂèëË¥ßÊï∞ÊçÆ')
          await shippingGoodsRef.value.loadTableData()
        }
        break
    }
    
    // ÂêåÊó∂Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
    await loadStats()
    
    console.log('‚úÖ Ê†áÁ≠æÈ°µÂàáÊç¢ÂÆåÊàêÔºåÊï∞ÊçÆÂ∑≤Âà∑Êñ∞')
  } catch (error) {
    console.error('Ê†áÁ≠æÈ°µÂàáÊç¢Âà∑Êñ∞Â§±Ë¥•:', error)
  }
}

onMounted(async () => {
  await loadStats()
  
  // ÊØè30ÁßíËá™Âä®Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
  setInterval(() => {
    loadStats()
  }, 30000)
})
</script>

<style lang="scss" scoped>
.outbound-management {
  padding: 20px;

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  
  h1 {
    margin: 0;
    color: #303133;
    font-size: 24px;
    font-weight: 600;
  }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
}

  .tabs-container {
  margin-bottom: 20px;
    
    .outbound-tabs {
      :deep(.el-tabs__header) {
        margin: 0 0 20px 0;
      }
      
      :deep(.el-tabs__nav) {
        border: none;
      }
      
      :deep(.el-tabs__item) {
        border: 1px solid #dcdfe6;
        border-radius: 4px 4px 0 0;
        margin-right: 5px;
        padding: 0 20px;
        
        &.is-active {
          background-color: #409eff;
          color: white;
          border-color: #409eff;
        }
      }
      
      .tab-icon {
        display: flex;
        align-items: center;
        gap: 5px;
        position: relative;
        
        .tab-badge {
          position: absolute;
          top: -8px;
          right: -15px;
        }
      }
    }
  }
  
  .stats-cards {
  margin-bottom: 20px;
  
  .stat-card {
      :deep(.el-card__body) {
        padding: 20px;
      }
      
    .stat-content {
      display: flex;
      align-items: center;
        gap: 15px;
      
      .stat-icon {
        width: 50px;
        height: 50px;
          border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
          font-size: 24px;
          color: white;
          
          &.draft {
            background: linear-gradient(135deg, #909399, #b1b3b8);
          }
          
          &.pre-delivery {
            background: linear-gradient(135deg, #e6a23c, #f0c78a);
          }
          
          &.picking {
            background: linear-gradient(135deg, #409eff, #79bbff);
          }
          
          &.packing {
            background: linear-gradient(135deg, #67c23a, #95d475);
          }
          
          &.shipping {
            background: linear-gradient(135deg, #f56c6c, #f89898);
          }
          
          &.completed {
            background: linear-gradient(135deg, #67c23a, #95d475);
          }
        }
        
        .stat-info {
          flex: 1;
          
        .stat-value {
            font-size: 28px;
          font-weight: 600;
          color: #303133;
          line-height: 1;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
          color: #909399;
        }
      }
    }
  }
}

  .tab-content {
    min-height: 500px;
  }
}
</style>